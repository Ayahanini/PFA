<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Médical - Maladies Cardiaques</title>
    <link rel="stylesheet" href="static/css/style.css">
    <!-- BotFramework WebChat -->
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
</head>
<body>
    <h1>Diagnostic de Connexion - Assistant Médical</h1>
    
    <div class="status-container" id="serverStatus">
        <h2>État du Serveur</h2>
        <p>Statut: <span id="statusText">Non vérifié</span></p>
        <button onclick="checkServerHealth()">Vérifier la connexion au serveur</button>
    </div>
    
    <div class="status-container" id="botStatus">
        <h2>État du Bot</h2>
        <p>Statut: <span id="botStatusText">Non vérifié</span></p>
        <button onclick="checkBotConnection()">Vérifier la connexion au bot</button>
    </div>
    
    <div class="status-container">
        <h2>Résultats</h2>
        <pre id="resultArea">Les résultats des tests apparaîtront ici...</pre>
    </div>
    
    <script>
        // URL de base de l'API - à modifier selon votre configuration
        const API_BASE_URL = 'http://localhost:3978';
        
        // Fonction pour tester la santé du serveur
        async function checkServerHealth() {
            const statusText = document.getElementById('statusText');
            const serverStatus = document.getElementById('serverStatus');
            const resultArea = document.getElementById('resultArea');
            
            try {
                statusText.textContent = "Tentative de connexion...";
                
                // Essayer d'abord l'endpoint de santé
                let response = await fetch(`${API_BASE_URL}/api/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusText.textContent = "Connecté";
                    serverStatus.className = "status-container status-ok";
                    resultArea.textContent = JSON.stringify(data, null, 2);
                    return;
                }
                
                // Si l'endpoint de santé n'existe pas, essayer une autre route
                response = await fetch(`${API_BASE_URL}/api/directline/token?userId=testuser`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusText.textContent = "Connecté (via token)";
                    serverStatus.className = "status-container status-ok";
                    resultArea.textContent = JSON.stringify(data, null, 2);
                } else {
                    statusText.textContent = "Erreur: " + response.status;
                    serverStatus.className = "status-container status-error";
                    resultArea.textContent = `Erreur HTTP ${response.status}: ${response.statusText}\n\nLe serveur est peut-être démarré mais rencontre des problèmes.`;
                }
            } catch (error) {
                statusText.textContent = "Impossible de se connecter";
                serverStatus.className = "status-container status-error";
                resultArea.textContent = `Erreur de connexion: ${error.message}\n\nLe serveur n'est probablement pas démarré ou n'est pas accessible.`;
            }
        }
        
        // Fonction pour tester la connexion au bot
        async function checkBotConnection() {
            const botStatusText = document.getElementById('botStatusText');
            const botStatus = document.getElementById('botStatus');
            const resultArea = document.getElementById('resultArea');
            
            try {
                botStatusText.textContent = "Tentative de connexion...";
                
                // Étape 1: Obtenir un token DirectLine
                const tokenResponse = await fetch(`${API_BASE_URL}/api/directline/token?userId=testuser`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (!tokenResponse.ok) {
                    botStatusText.textContent = "Erreur d'obtention du token";
                    botStatus.className = "status-container status-error";
                    resultArea.textContent = `Erreur HTTP ${tokenResponse.status}: ${tokenResponse.statusText}\n\nImpossible d'obtenir un token DirectLine.`;
                    return;
                }
                
                const tokenData = await tokenResponse.json();
                
                // Étape 2: Envoyer un message de test
                const messageResponse = await fetch(`${API_BASE_URL}/api/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${tokenData.token}`
                    },
                    body: JSON.stringify({
                        type: "message",
                        from: { id: "testuser" },
                        text: "test de connexion"
                    })
                });
                
                if (messageResponse.ok) {
                    botStatusText.textContent = "Connecté au bot";
                    botStatus.className = "status-container status-ok";
                    resultArea.textContent = "Message envoyé avec succès au bot.\n\nToken: " + JSON.stringify(tokenData, null, 2);
                } else {
                    botStatusText.textContent = "Erreur d'envoi de message";
                    botStatus.className = "status-container status-error";
                    resultArea.textContent = `Erreur HTTP ${messageResponse.status}: ${messageResponse.statusText}\n\nImpossible d'envoyer un message au bot.`;
                }
            } catch (error) {
                botStatusText.textContent = "Impossible de se connecter";
                botStatus.className = "status-container status-error";
                resultArea.textContent = `Erreur de connexion: ${error.message}\n\nLe bot n'est probablement pas disponible.`;
            }
        }
    </script>
</body>
</html>