<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Médical - Maladies Cardiaques</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- BotFramework WebChat -->
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Assistant Médical - Maladies Cardiaques</h1>
            <p>Posez vos questions sur les maladies cardiaques ou demandez une prédiction de risque</p>
        </header>
        
        <main>
            <div class="chat-container">
                <div id="webchat" role="main"></div>
                <!-- Interface de secours si le WebChat ne se charge pas -->
                <div id="fallback-interface" style="display: none;">
                    <div class="fallback-messages" id="fallback-messages"></div>
                    <div class="fallback-input">
                        <input type="text" id="fallback-message-input" placeholder="Tapez votre message ici...">
                        <button id="fallback-send-button">Envoyer</button>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>© 2025 - Assistant Médical - Tous droits réservés</p>
        </footer>
    </div>

    <script>
        // Configuration simple sans dépendance à un service Direct Line
        (function() {
            // Sélectionner les éléments
            const webchatElement = document.getElementById('webchat');
            const fallbackInterface = document.getElementById('fallback-interface');
            const fallbackMessages = document.getElementById('fallback-messages');
            const fallbackInput = document.getElementById('fallback-message-input');
            const fallbackSendButton = document.getElementById('fallback-send-button');
            
            // Afficher le WebChat directement
            try {
                // Obtenir un token Direct Line de notre API
                fetch(window.location.origin + '/api/directline/token')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Token Direct Line obtenu:", data.token);
                        
                        // URL pour les messages de l'API
                        const apiUrl = window.location.origin + '/api/messages';
                        
                        // Création d'une connexion Direct Line avec notre token
                        const directLine = window.WebChat.createDirectLine({
                            token: data.token,
                            domain: apiUrl,
                            webSocket: false  // Utiliser des requêtes HTTP au lieu de WebSocket
                        });
                
                // Options de style
                const styleOptions = {
                    bubbleBackground: '#F5F5F5',
                    bubbleBorderColor: '#E5E5E5',
                    bubbleBorderRadius: 10,
                    bubbleFromUserBackground: '#3498db',
                    bubbleFromUserBorderColor: '#2980b9',
                    bubbleFromUserBorderRadius: 10,
                    bubbleFromUserTextColor: 'white',
                    sendBoxButtonColor: '#3498db',
                    backgroundColor: 'white',
                    rootHeight: '100%',
                    rootWidth: '100%'
                };
                
                // Rendre le chat
                window.WebChat.renderWebChat(
                    {
                        directLine: directLine,
                        userID: 'user-' + Math.random().toString(36).substring(2, 7),
                        username: 'Utilisateur',
                        locale: 'fr-FR',
                        styleOptions: styleOptions
                    },
                    webchatElement
                );
                
                // Afficher un message initial après 1 seconde
                setTimeout(() => {
                    // Si après 3 secondes le WebChat n'est pas initialisé correctement, montrer l'interface de secours
                    if (!webchatElement.querySelector('.webchat__basic-transcript')) {
                        console.error("WebChat ne s'est pas initialisé correctement, utilisation de l'interface de secours");
                        webchatElement.style.display = 'none';
                        fallbackInterface.style.display = 'flex';
                        
                        // Ajouter un message de bienvenue à l'interface de secours
                        addFallbackMessage('bot', 'Bonjour! Je suis votre assistant médical spécialisé dans les maladies cardiaques. Comment puis-je vous aider aujourd\'hui?');
                    }
                }, 3000);
                    })
                    .catch(error => {
                        console.error("Erreur lors de l'obtention du token:", error);
                        webchatElement.style.display = 'none';
                        fallbackInterface.style.display = 'flex';
                        addFallbackMessage('bot', 'Bonjour! Je suis votre assistant médical spécialisé dans les maladies cardiaques. Comment puis-je vous aider aujourd\'hui?');
                    });
            } catch (error) {
                console.error("Erreur lors de l'initialisation de WebChat:", error);
                webchatElement.style.display = 'none';
                fallbackInterface.style.display = 'flex';
                
                // Ajouter un message de bienvenue à l'interface de secours
                addFallbackMessage('bot', 'Bonjour! Je suis votre assistant médical spécialisé dans les maladies cardiaques. Comment puis-je vous aider aujourd\'hui?');
            }
            
            // Fonctions pour l'interface de secours
            function addFallbackMessage(sender, text) {
                const messageElement = document.createElement('div');
                messageElement.className = `fallback-message ${sender === 'user' ? 'fallback-user-message' : 'fallback-bot-message'}`;
                messageElement.textContent = text;
                fallbackMessages.appendChild(messageElement);
                fallbackMessages.scrollTop = fallbackMessages.scrollHeight;
            }
            
            // Gestionnaire pour l'envoi de messages dans l'interface de secours
            fallbackSendButton.addEventListener('click', sendFallbackMessage);
            fallbackInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendFallbackMessage();
                }
            });
            
            function sendFallbackMessage() {
                const messageText = fallbackInput.value.trim();
                if (messageText) {
                    // Afficher le message de l'utilisateur
                    addFallbackMessage('user', messageText);
                    
                    // Effacer l'entrée
                    fallbackInput.value = '';
                    
                    // Envoyer le message à l'API
                    fetch('/api/question', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ question: messageText })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Afficher la réponse du bot
                        if (data.answer) {
                            addFallbackMessage('bot', data.answer);
                        } else if (data.error) {
                            addFallbackMessage('bot', 'Désolé, une erreur s\'est produite: ' + data.error);
                        } else {
                            addFallbackMessage('bot', 'Je ne sais pas comment répondre à cette question.');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        addFallbackMessage('bot', 'Désolé, je n\'ai pas pu traiter votre demande en raison d\'une erreur technique.');
                    });
                }
            }
        })();
    </script>
</body>
</html>